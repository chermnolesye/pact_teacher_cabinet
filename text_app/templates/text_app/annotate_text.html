<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Разметка текста</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/base.css' %}" />
    <link rel="stylesheet" href="{% static 'css/text_markup.css' %}" />
</head>
<body>
    <div class="text-app-container">

        <div class="menu-container">
            <!-- Блоки меню -->
            <div class="menu-block" data-target="view-content">
                <span>
                    Вид
                    <svg width="10" height="10" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5753 2L7.70808 10.5L1.84082 2" stroke="#0d6efd" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </span>
            </div>
            <div class="menu-block" data-target="text-content">
                <span>
                    Текст
                    <svg width="10" height="10" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5753 2L7.70808 10.5L1.84082 2" stroke="#0d6efd" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </span>
            </div>
            <div class="menu-block" data-target="author-content">
                <span>
                    Автор
                    <svg width="10" height="10" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5753 2L7.70808 10.5L1.84082 2" stroke="#0d6efd" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </span>
            </div>
            <div class="menu-block" data-target="grade-content">
                <span>
                    Оценка
                    <svg width="10" height="10" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5753 2L7.70808 10.5L1.84082 2" stroke="#0d6efd" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </span>
            </div>
            <div class="menu-block" data-target="metadata-content">
                <span>
                    Метаданные
                    <svg width="10" height="10" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5753 2L7.70808 10.5L1.84082 2" stroke="#0d6efd" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </span>
            </div>
            <button class="rate-btn">Оценить</button>
        </div>

        <div id="header-container"></div>
        <!-- Всплывающее окно с информацией об ошибке -->
        <div class="error-popup" id="error-popup">
            <!-- <span class="close-btn" id="close-popup">&#x2715;</span> -->
            <h3>
                <span id="error-tag"></span>
                <span id="error-tag-abbrev"></span>
            </h3>
            <p><strong>Степень грубости:</strong> <span id="error-level"></span></p>
            <p><strong>Причина ошибки:</strong> <span id="error-reason"></span></p>
            <p><strong>Исправление:</strong> <span id="error-correct"></span></p>
            <p><strong>Комментарий:</strong> <span id="error-comment"></span></p>
        </div>


        <!-- Контентные блоки -->
        <div class="menu-content" id="view-content">
            <div class="menu-content-view">

                <div class="option-group">
                    <p>Язык разметки</p>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="language" value="deutsche" checked>
                            <span class="radio-custom"></span>
                            <span>Deutsche</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="language" value="russian">
                            <span class="radio-custom"></span>
                            <span>Русский</span>
                        </label>
                    </div>
                </div>

                <div class="option-group">
                    <p>Компактный вид</p>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="option-group">
                    <p>Части речи</p>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="option-group">
                    <p>Ошибки</p>
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>

            </div>
        </div>
        <div class="menu-content" id="text-content">
            <div class="menu-content-data">
                <p>Курс создания:</p>
                <p class="p-dark"> {{ year_study_language }} </p>
            </div>
            <div class="menu-content-data">
                <p>Дата создания:</p>
                <p class="p-dark"> {{ create_date|default:"Нет данных" }} </p>
            </div>
        </div>
        <div class="menu-content" id="author-content">

            <div class="menu-content-data">
                <p>Имя:</p>
                <p class="p-dark"> {{ author|default:"Нет данных" }} </p>
            </div>
            <div class="menu-content-data">
                <p>Группа:</p>
                <p class="p-dark"> {{ group|default:"Нет данных" }} ({{ academic_year|default:"Нет данных" }}) </p>
            </div>
        </div>
        <div class="menu-content" id="grade-content">
            <div class="menu-content-grade">
                <div class="menu-content-grade-col ">
                    <p>Оценка работы</p>
                    <div class="menu-content-data">
                        <p>Оценка:</p>
                        <p class="p-dark"> {{ textgrade }} </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Полнота:</p>
                        <p class="p-dark"> {{ completeness }} </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Структура:</p>
                        <p class="p-dark"> {{ structure }} </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Связность:</p>
                        <p class="p-dark"> {{ coherence }} </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Проверяющий:</p>
                        <p class="p-dark"> {{userteacher}} </p>
                    </div>

                    <p>Частеречная разметка</p>
                    <div class="menu-content-data">
                        <p>Статус:</p>
                        {% if poscheckflag %}
                        <p class="p-green"> Проверено </p>
                        {% else %}
                        <p class="p-red"> Не проверено </p>
                        {% endif %}
                    </div>
                    <p>Разметка ошибок</p>
                    <div class="menu-content-data">
                        <p>Статус:</p>
                        {% if errorcheckflag %}
                        <p class="p-green"> Проверено </p>
                        {% else %}
                        <p class="p-red"> Не проверено </p>
                        {% endif %}
                    </div>
                    <div class="menu-content-data">
                        <p>Проверяющий:</p>
                        <p class="p-dark">  {{usererrorcheck}} </p>
                    </div>
                </div>

                <div class="menu-content-grade-col ">
                    <p>Автооценка: Грамматика</p>
                    <div class="menu-content-data">
                        <p>Степень 1:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 2:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 3:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Оценка:</p>
                        <p class="p-dark">  </p>
                    </div>

                    <p>Автооценка: Лексика</p>
                    <div class="menu-content-data">
                        <p>Степень 1:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 2:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 3:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Оценка:</p>
                        <p class="p-dark">  </p>
                    </div>

                    <p>Автооценка: Орфография и пунктуация</p>
                    <div class="menu-content-data">
                        <p>Степень 1:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 2:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Степень 3:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Оценка:</p>
                        <p class="p-dark">  </p>
                    </div>

                    <p>Автооценка: Подсчет ошибок</p>
                    <div class="menu-content-data">
                        <p>Дискурс:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Пропуски:</p>
                        <p class="p-dark">  </p>
                    </div>
                    <div class="menu-content-data">
                        <p>Лишние элементы:</p>
                        <p class="p-dark">  </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="menu-content" id="metadata-content">
            <div class="menu-content-data">
                <p>Эмоционально-физиологическое состояние:</p>
                <p class="p-dark"> {{ emotion }} </p>
            </div>
            <div class="menu-content-data">
                <p>Место написания:</p>
                <p class="p-dark"> {{ write_place }} </p>
            </div>
            <div class="menu-content-data">
                <p>Год изучения языка:</p>
                <p class="p-dark"> {{ year_study_language }} </p>
            </div>
            <div class="menu-content-data">
                <p>Самооценивание:</p>
                <p class="p-dark"> {{ self_rating }} </p>
            </div>
            <div class="menu-content-data">
                <p>Оценка задания студентом:</p>
                <p class="p-dark"> {{ self_assesment }} </p>
            </div>
        </div>


        <!-- Модальное окно для оценки текста -->
        <div class="modal-overlay" id="modal">
            <div class="modal-content">
                <div class="modal-head">
                    <p>Оценить текст</p>
                    <button class="close-modal">
                        <svg width="30" height="30" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M27.101 17.0606L17.0606 27.101M17.0606 17.0606L27.101 27.101M12.0404 4.68683C15.0917 2.92153 18.5556 1.99459 22.0808 2.00002C33.1714 2.00002 42.1616 10.9902 42.1616 22.0808C42.1616 33.1714 33.1714 42.1616 22.0808 42.1616C10.9902 42.1616 2 33.1714 2 22.0808C2 18.4241 2.97794 14.9923 4.68681 12.0404" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>

                <form method="post" id="grade-form">
                    {% csrf_token %}
                    <div class="grade-form-selects">
                        <div class="grade-group">
                            {{ grade_form.textgrade.label_tag }}
                            {{ grade_form.textgrade }}
                        </div>

                        <div class="horizontal-wrap">
                            <div class="grade-group">
                                {{ grade_form.completeness.label_tag }}
                                {{ grade_form.completeness }}
                            </div>
                            <div class="grade-group">
                                {{ grade_form.structure.label_tag }}
                                {{ grade_form.structure }}
                            </div>
                            <div class="grade-group">
                                {{ grade_form.coherence.label_tag }}
                                {{ grade_form.coherence }}
                            </div>
                        </div>

                        <div class="horizontal-wrap">
                            <div class="grade-group">
                                {{ grade_form.poscheckflag.label_tag }}
                                {{ grade_form.poscheckflag }}
                            </div>
                            <div class="grade-group">
                                {{ grade_form.errorcheckflag.label_tag }}
                                {{ grade_form.errorcheckflag }}
                            </div>
                        </div>
                    </div>

                    <div class="grade-buttons">
                        <button type="submit" name="grade-form" class="button" onclick="addAnnotation()">Сохранить</button>
                        <button type="submit" class="button grey-button">Назад</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-header">
            <h1 class="text-title">{{ text.header }}</h1>
        </div>

        <div class="watch-text">
            {% for sentence in sentence_data %}
            <div class="sentence">
                <div class="tokens-container" id_sentence="{{ sentence.id_sentence }}">
                    <p class="sentence-number">{{ sentence.sentence.ordernumber|add:1 }}:</p>
                    {% for token in sentence.tokens %}

                    <svg class="clickable-icon" width="20" height="20" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M34.5 27H27M27 27H19.5M27 27V19.5M27 27V34.5M14.5 5.34503C18.2988 3.14728 22.6113 1.99327 27 2.00003C40.8075 2.00003 52 13.1925 52 27C52 40.8075 40.8075 52 27 52C13.1925 52 2 40.8075 2 27C2 22.4475 3.2175 18.175 5.345 14.5" stroke="#768088" stroke-width="4" stroke-linecap="round" />
                    </svg>
                    <span class="token"
                          id_token="{{ token.token_id }}"
                          data-pos-tag="{{ token.pos_tag }}"
                          data-pos-tag-russian="{{ token.pos_tag_russian }}"
                          data-pos-tag-abbrev="{{ token.pos_tag_abbrev }}"
                          data-pos-color="{{ token.pos_tag_color }}"
                          data-position="{{ token.token_order_number }}"
                          {% if token.error_tag %}
                          data-error-tag="{{ token.error_tag }}"
                          data-error-tag-russian="{{ token.error_tag_russian }}"
                          data-error-tag-abbrev="{{ token.error_tag_abbrev }}"
                          data-error-level="{{ token.error_level }}"
                          data-error-color="{{ token.error_color }}"
                          {% endif %}>

                        {% if token.all_errors %}
                        {% for error in token.all_errors %}
                        <span class="error-tag"
                              style="background-color: {{ error.error_color }}; display: none;"
                              data-error-tag="{{ error.error_tag }}"
                              data-error-tag-russian="{{ error.error_tag_russian }}"
                              data-error-tag-abbrev="{{ error.error_tag_abbrev }}"
                              data-error-level="{{ token.error_level }}"
                              data-error-correct="{{ token.error_correct }}"
                              data-error-comment="{{ token.error_comment }}"
                              data-all-errors="{{ token.all_errors|safe|escapejs }}"
                              data-error-reason="{{ token.error_reason }}">
                            {{ error.error_tag }}
                        </span>
                        {% endfor %}
                        {% endif %}

                        {% if token.pos_tag %}
                        <span class="abbr"
                              style="background-color: {{ token.pos_tag_color }}; display: none;"
                              data-pos-tag="{{ token.pos_tag }}"
                              data-pos-tag-russian="{{ token.pos_tag_russian }}"
                              data-pos-tag-abbrev="{{ token.pos_tag_abbrev }}">
                            {{ token.pos_tag }}
                        </span>
                        {% endif %}

                        {% if token.token == '-EMPTY-' %}
                        <span class="word">
                            <svg xmlns="http://www.w3.org/2000/svg" class="bi" height="1em" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="1.5" d="m14.36 4.079.927-.927a3.932 3.932 0 0 1 5.561 5.561l-.927.927m-5.56-5.561s.115 1.97 1.853 3.707C17.952 9.524 19.92 9.64 19.92 9.64m-5.56-5.561L12 6.439m7.921 3.2-5.26 5.262L11.56 18l-.16.161c-.578.577-.867.866-1.185 1.114a6.554 6.554 0 0 1-1.211.749c-.364.173-.751.302-1.526.56l-3.281 1.094m0 0-.802.268a1.06 1.06 0 0 1-1.342-1.342l.268-.802m1.876 1.876-1.876-1.876m0 0 1.094-3.281c.258-.775.387-1.162.56-1.526.205-.43.456-.836.749-1.211.248-.318.537-.607 1.114-1.184L8.5 9.939"></path></svg>
                        </span>
                        {% else %}
                        <span class="word">{{ token.token }}</span>
                        {% endif %}
                    </span>
                    {% endfor %}
                    <svg class="clickable-icon" width="20" height="20" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M34.5 27H27M27 27H19.5M27 27V19.5M27 27V34.5M14.5 5.34503C18.2988 3.14728 22.6113 1.99327 27 2.00003C40.8075 2.00003 52 13.1925 52 27C52 40.8075 40.8075 52 27 52C13.1925 52 2 40.8075 2 27C2 22.4475 3.2175 18.175 5.345 14.5" stroke="#768088" stroke-width="4" stroke-linecap="round" />
                    </svg>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Окно для добавления аннотации ошибки -->
        <div id="annotation-modal" class="modal-overlay">
            <div class="modal-content">

                <div class="modal-head">
                    <p>Аннотация</p>
                    <button class="close-modal" id="close-modal">
                        <svg width="30" height="30" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M27.101 17.0606L17.0606 27.101M17.0606 17.0606L27.101 27.101M12.0404 4.68683C15.0917 2.92153 18.5556 1.99459 22.0808 2.00002C33.1714 2.00002 42.1616 10.9902 42.1616 22.0808C42.1616 33.1714 33.1714 42.1616 22.0808 42.1616C10.9902 42.1616 2 33.1714 2 22.0808C2 18.4241 2.97794 14.9923 4.68681 12.0404" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>

                <form method="post" id="annotation-form">
                    {% csrf_token %}
                    <div class="annotation-modal-content">
                        <div style="width: 100%; overflow: hidden;">
                            <label id="tags-label" for="id_iderrortag" style="width: 550px; float: left; margin-top:15px;">Выберите тег:</label>
                            <!--<input type="text" id="tag-search" placeholder="Поиск тега" class="tag-search" style="width: 420px;">-->
                        </div>

                        <div class="selected-tag-display">
                            Выбранный тег: <span id="selected-tag-name">Не выбран</span>
                        </div>

                        {{ annotation_form.iderrortag.label_tag }}
                        {{ annotation_form.iderrortag }}

                        {{ annotation_form.idreason.label_tag }}
                        {{ annotation_form.idreason }}

                        {{ annotation_form.iderrorlevel.label_tag }}
                        {{ annotation_form.iderrorlevel }}

                        {{ annotation_form.correct.label_tag}}
                        {{ annotation_form.correct }}

                        {{ annotation_form.comment.label_tag }}
                        {{ annotation_form.comment }}

                        <p id="author_id">Создатель аннотации: <p>

                            <div class="grade-buttons">
                                <!-- Нужно написать функцию  для добавления в бд аннотации -->
                                <button type="submit" name="annotation-form" class="button" id="save-annotation" onclick="addErrorAnnotation()">Сохранить</button>
                                <button class="button red-button" id="delete-annotation">Удалить</button>
                            </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="select-menu" class="hide">
            <button class="button-menu-select" id="button-add-annotation">Добавить аннотацию</button>
            <button class="button-menu-select" id="button-delete-tokens">Удалить выбранные пустые токены</button>
            <button class="button-menu-select" id="button-remove-highlight">Снять выделение</button>
        </div>
        <!-- Шапка убрать коммент, если нужна  -->
        <!-- <script>
        document.addEventListener('DOMContentLoaded', function() {
        fetch('/static/templates/base.html')
            .then(response => response.text())
            .then(data => {
            document.getElementById('header-container').innerHTML = data;
            let user_fio = "{{ fio|escapejs }}";
            document.getElementById('user-link').textContent = user_fio;
            });
        });

    </script> -->
        <script>
        const chosen = [];
        const chosen_ids = [];

        // Скрипт для отображения разметки (НЕ ДЫШАТЬ НА НЕГО!!!)
        document.addEventListener('DOMContentLoaded', function() {
            const languageRadios = document.querySelectorAll('input[name="language"]');
            const compactViewCheckbox = document.querySelector('.option-group:nth-child(2) input[type="checkbox"]');
            const posCheckbox = document.querySelector('.option-group:nth-child(3) input[type="checkbox"]');
            const errorsCheckbox = document.querySelector('.option-group:nth-child(4) input[type="checkbox"]');
            const tokens = document.querySelectorAll('.token');

            // Функция обновления отображения
            function updateDisplay() {
                const language = document.querySelector('input[name="language"]:checked').value;
                const isCompact = compactViewCheckbox.checked;
                const showPOS = posCheckbox.checked;
                const showErrors = errorsCheckbox.checked;

                tokens.forEach(token => {
                    token.querySelectorAll('.abbr, .error-tag, .word').forEach(el => {
                        el.style.display = 'none';
                    });

                    const word = token.querySelector('.word');
                    if (word) word.style.display = 'inline';

                    if (showPOS) {
                        const posTag = token.querySelector('.abbr');
                        if (posTag) {
                            posTag.style.display = 'inline';
                            if (isCompact) {
                                posTag.textContent = posTag.dataset.posTagAbbrev ||
                                    (language === 'russian' ? posTag.dataset.posTagRussian : posTag.dataset.posTagAbbrev);
                            } else {
                                posTag.textContent = language === 'russian' ?
                                    posTag.dataset.posTagRussian : posTag.dataset.posTag;
                            }
                        }
                    }

                    // Обработка ошибок
                    if (showErrors) {
                        const errorTags = token.querySelectorAll('.error-tag');
                        if (errorTags.length > 0) {
                            errorTags.forEach(tag => {
                                tag.style.display = 'inline';
                                if (isCompact) {
                                    tag.textContent = tag.dataset.errorTagAbbrev;
                                } else {
                                    tag.textContent = language === 'russian' ?
                                        tag.dataset.errorTagRussian : tag.dataset.errorTag;
                                }
                            });
                        }
                    }
                });
            }

            // Обработчики событий
            languageRadios.forEach(radio => {
                radio.addEventListener('change', updateDisplay);
            });

            [compactViewCheckbox, posCheckbox, errorsCheckbox].forEach(checkbox => {
                checkbox.addEventListener('change', updateDisplay);
            });

            // Инициализация
            updateDisplay();
        });

        document.addEventListener('DOMContentLoaded', function() {
            const popup = document.getElementById('error-popup');
            const closePopupBtn = document.getElementById('close-popup');
            let list_tags = {};

            async function fetchDataAsync(url, let_tags) {
                const response = await fetch(url);
                list_tags = await response.json();
                console.log(list_tags);
            }

            fetchDataAsync('/text/get_tags/', list_tags);

            function AddEllWithChildren(category_content, inner_tag, children) {
                const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                const iconPath = document.createElementNS(
                    'http://www.w3.org/2000/svg',
                    'path'
                );

                iconSvg.setAttribute('fill', 'none')
                iconSvg.setAttribute('viewBox', '0 0 24 24');
                iconSvg.setAttribute('stroke', 'black');
                iconPath.setAttribute(
                    'd',
                    'M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5'
                );
                iconPath.setAttribute('stroke-linecap', 'round');
                iconPath.setAttribute('stroke', '#768088');
                iconPath.setAttribute('stroke-width', '1.5');

                iconSvg.appendChild(iconPath);

                const iconPath1 = document.createElementNS(
                    'http://www.w3.org/2000/svg',
                    'path'
                );

                iconPath1.setAttribute(
                    'd',
                    'm10.5 9 3 3-3 3'
                );
                iconPath1.setAttribute('stroke-linecap', 'round');
                iconPath1.setAttribute('stroke', '#768088');
                iconPath1.setAttribute('stroke-width', '1.5');

                iconSvg.appendChild(iconPath1);
                iconSvg.style.height = "35px";
                iconSvg.style.width = "35px";
                iconSvg.style.display = 'inline-block';
                iconSvg.style.paddingTop = '5px';
                iconSvg.classList.add('tag-icon');
                iconSvg.classList.add('tag-icon-close');

                iconSvg.addEventListener('click', () => {
                    //console.log(iconSvg.children);
                    const path1 = iconSvg.children[0];
                    const path2 = iconSvg.children[1];

                    if (iconSvg.classList.contains('tag-icon-close')) {
                        children.style.display = 'block';
                        path1.setAttribute(
                            'd',
                            'm15 10.5-3 3-3-3'
                        );
                        path2.setAttribute(
                            'd',
                            'M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5'
                        );
                        iconSvg.classList.remove('tag-icon-close');
                    }
                    else {
                        children.style.display = 'none';
                        path1.setAttribute(
                            'd',
                            'M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5'
                        );
                        path2.setAttribute(
                            'd',
                            'm10.5 9 3 3-3 3'
                        );
                        iconSvg.classList.add('tag-icon-close');
                    }
                });
                category_content.appendChild(iconSvg);
                inner_tag.style.display = 'inline-block';
                inner_tag.style.marginLeft = '10px';

            }

            function TagAddChildren(index, parent_id, newToken) {
                for (var i = index; i < tags_info.length; i++) {
                    tag = tags_info[i];

                    if (tag["parent_id"] === parent_id) {
                        //console.log(tag);
                        const category = document.createElement('div');
                        category.classList.add('category');

                        const category_content = document.createElement('div');
                        category_content.style.display = 'flex';
                        const inner_tag = document.createElement('div');
                        inner_tag.classList.add('tag');
                        inner_tag.style.width = "fit-content";
                        inner_tag.style.backgroundColor = tag['tag_color'];
                        category_content.style.marginBottom = '5px';
                        inner_tag.id = tag['tag_id'];
                        inner_tag.innerHTML = tag['tag_text'];

                        const children = document.createElement('div');
                        children.style.display = 'none';
                        children.style.marginLeft = '50px';
                        if (tag['has_children'] === true) {
                            AddEllWithChildren(category_content, inner_tag, children);
                        }
                        category_content.appendChild(inner_tag);
                        category.appendChild(category_content);
                        newToken.appendChild(category);

                        if (tag['has_children'] === true) {
                            TagAddChildren(i, tag['tag_id'], children)
                            category.appendChild(children);
                        }
                    }
                }
            }

            function createSelect() {
                const parent = document.getElementsByClassName('annotation-modal-content')[0]; 
                const newToken = document.createElement('div');
                newToken.classList.add('select-for-tags');
                const nextElement = document.getElementsByClassName('selected-tag-display')[0];
                //console.log(list_tags);
                //console.log(parent.children);
                tags_info=list_tags["tags_info"];

                TagAddChildren(0, 0, newToken);
                newToken.style.height = "250px";
                newToken.style.overflowY = "scroll";
                parent.insertBefore(newToken, nextElement);
            }

            // Функция для отображения всплывающего окна с информацией об ошибке
            function showPopup(tokenElement) {
                const errorTag = tokenElement.dataset.errorTag;
                const errorTagAbbrev = tokenElement.dataset.errorTagAbbrev;
                const errorLevel = tokenElement.dataset.errorLevel;
                const errorReason = tokenElement.dataset.errorReason;
                const errorCorrect = tokenElement.dataset.errorCorrect;
                const errorComment = tokenElement.dataset.errorComment;

                if (!errorTag) {
                    return;
                }

                document.getElementById('error-tag').textContent = errorTag || 'Не указано';
                document.getElementById('error-tag-abbrev').textContent = errorTagAbbrev ? `(${errorTagAbbrev})` : '';
                document.getElementById('error-level').textContent = errorLevel || 'Не указано';
                document.getElementById('error-reason').textContent = errorReason || 'Не указано';
                document.getElementById('error-correct').textContent = errorCorrect || 'Не указано';
                document.getElementById('error-comment').textContent = errorComment || 'Не указано';

                const rect = tokenElement.getBoundingClientRect();
                const offsetLeft = rect.left + window.scrollX;
                const offsetTop = rect.top + window.scrollY;
                const height = rect.height;

                const popup = document.getElementById('error-popup');
                popup.style.display = 'block'; // Нужно, чтобы offsetHeight был доступен
                popup.classList.add('show');

                const popupHeight = popup.offsetHeight;
                const spaceAbove = rect.top;
                const spaceBelow = window.innerHeight - rect.bottom;

                let top;
                if (spaceAbove >= popupHeight + 10) {
                    // Есть место сверху — показываем над токеном
                    top = offsetTop - popupHeight - 6;
                } else {
                    // Места сверху нет — показываем под токеном
                    top = offsetTop + height + 6;
                }

                popup.style.left = `${offsetLeft}px`;
                popup.style.top = `${top}px`;
            }

            function EditAnnotationForm(tokenElement) {
                document.getElementById('selected-tag-name').innerHTML = tokenElement.dataset.errorTag;

                const id_idreason = document.getElementById('id_idreason');
                var options = id_idreason.options;
                var chosen = 0;
                for (var i = 0; i < options.length; i++) {
                    var option = options[i];
                    if (option.text === tokenElement.dataset.errorReason) {
                        chosen = option.value;
                    }
                }
                id_idreason.getElementsByTagName('option')[chosen].selected = 'selected';

                const id_iderrorlevel = document.getElementById('id_iderrorlevel');
                options = id_iderrorlevel.options;
                chosen = 0;
                for (var i = 0; i < options.length; i++) {
                    var option = options[i];
                    if (option.text === tokenElement.dataset.errorLevel) {
                        chosen = option.value;
                    }
                } 
                id_iderrorlevel.getElementsByTagName('option')[chosen].selected = 'selected';

                if (tokenElement.dataset.errorComment !== "Не указано") {
                    document.getElementById('id_comment').value = tokenElement.dataset.errorComment;
                }

                if (tokenElement.dataset.errorCorrect !== "Не указано") {
                    document.getElementById('id_correct').value = tokenElement.dataset.errorCorrect;
                }
            }

            // Закрытие окна с анимацией
            /*closePopupBtn.addEventListener('click', function() {
                const popup = document.getElementById('error-popup');
                popup.classList.remove('show'); // Убираем класс для анимации исчезновения
                setTimeout(() => {
                    popup.style.display = 'none'; // Скрываем окно после анимации
                }, 300); // Задержка, соответствующая длительности перехода
            });*/

            // Слушаем клик по токенам
            document.querySelectorAll('.error-tag').forEach(function(errorTagElement) {
                errorTagElement.addEventListener('mouseover', function(e) {
                    e.stopPropagation(); // Чтобы не всплывало до .token
                    showPopup(this);
                });
                errorTagElement.addEventListener('click', function (e) {
                    createSelect();
                    document.getElementById('annotation-modal').style.display = 'flex';
                    EditAnnotationForm(this);
                });
                errorTagElement.addEventListener('mouseleave', function (e) {
                    const popup = document.getElementById('error-popup');
                    popup.classList.remove('show'); // Убираем класс для анимации исчезновения
                    setTimeout(() => {
                        popup.style.display = 'none'; // Скрываем окно после анимации
                    }, 300); // Задержка, соответствующая длительности перехода
                });
            });

            function ClickOnWord(word) {
                var menu = document.getElementById('select-menu');
                if (word.classList.contains('chosen_token')) {
                    word.classList.remove('chosen_token');
                    var index = chosen.indexOf(word);
                    if (index > -1) {
                        chosen.splice(index, 1);
                    }
                    if (chosen.length == 0) {
                        menu.classList.add('hide');
                    }
                }
                else {
                    if (menu.classList.contains('hide')) {
                        menu.classList.remove('hide');
                        button_deselect = document.getElementById('button-remove-highlight');
                        button_deselect.addEventListener('click', () => {
                            document.querySelectorAll('.chosen_token').forEach(icon => {
                                icon.classList.remove('chosen_token');
                            });
                            var menu = document.getElementById('select-menu');
                            menu.classList.add('hide');
                            chosen.splice(0, chosen.length);
                        });
                    }
                    word.classList.add('chosen_token');
                    let token = word.parentElement;
                    chosen.push(word);
                    if (token.hasAttribute('id_token')){
                        chosen_ids.push(token.getAttribute('id_token'));
                    };
                }
            }

            function ChangePositions(tokens_container, el) {
                var allChildren = tokens_container.getElementsByClassName("token")
                console.log(allChildren)

                //const allChildren = Array.from(tokens_container.children);
                let position = 0;
                if (el) {
                    position = el.getAttribute("data-position");
                }
                //console.log(position);
                for (var i = position; i < allChildren.length; i++) {
                    var child = allChildren[i];
                    if (child.hasAttribute("data-position")) {
                        child.setAttribute('data-position', position);
                        //console.log(child);
                        position++;
                    }
                }
            }

            // функция для добавления токена пропущенного слова и токена рядом с ним
            function ClickOnEmpty(icon) {
                const newToken = document.createElement('span');
                newToken.className = 'token';

                var innerSpan = document.createElement('span');
                innerSpan.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="bi" height="1em" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="1.5" d="m14.36 4.079.927-.927a3.932 3.932 0 0 1 5.561 5.561l-.927.927m-5.56-5.561s.115 1.97 1.853 3.707C17.952 9.524 19.92 9.64 19.92 9.64m-5.56-5.561L12 6.439m7.921 3.2-5.26 5.262L11.56 18l-.16.161c-.578.577-.867.866-1.185 1.114a6.554 6.554 0 0 1-1.211.749c-.364.173-.751.302-1.526.56l-3.281 1.094m0 0-.802.268a1.06 1.06 0 0 1-1.342-1.342l.268-.802m1.876 1.876-1.876-1.876m0 0 1.094-3.281c.258-.775.387-1.162.56-1.526.205-.43.456-.836.749-1.211.248-.318.537-.607 1.114-1.184L8.5 9.939"></path></svg>';
                innerSpan.className = 'word';
                innerSpan.classList.add('empty-token');
                innerSpan.addEventListener('click', () => {
                    ClickOnWord(innerSpan);
                });

                let token = icon.parentElement;
                console.log(token);
                let word = icon.previousElementSibling;
                console.log(word);

                newToken.setAttribute('sentence_id', token.getAttribute('id_sentence'));
                newToken.setAttribute('data-position', 0);

                newToken.appendChild(innerSpan);

                const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                const iconPath = document.createElementNS(
                    'http://www.w3.org/2000/svg',
                    'path'
                );

                iconSvg.setAttribute('fill', 'none');
                iconSvg.setAttribute('height', '20');
                iconSvg.setAttribute('width', '20');
                iconSvg.setAttribute('viewBox', '0 0 54 54');
                iconSvg.setAttribute('stroke', 'black');
                iconSvg.classList.add('clickable-icon');
                iconSvg.classList.add('empty-token');
                iconPath.setAttribute(
                    'd',
                    'M34.5 27H27M27 27H19.5M27 27V19.5M27 27V34.5M14.5 5.34503C18.2988 3.14728 22.6113 1.99327 27 2.00003C40.8075 2.00003 52 13.1925 52 27C52 40.8075 40.8075 52 27 52C13.1925 52 2 40.8075 2 27C2 22.4475 3.2175 18.175 5.345 14.5'
                );
                iconPath.setAttribute('stroke-linecap', 'round');
                iconPath.setAttribute('stroke', '#768088');
                iconPath.setAttribute('stroke-width', '4');

                iconSvg.addEventListener('click', () => {
                    ClickOnEmpty(iconSvg);
                });

                iconSvg.appendChild(iconPath);

                const parent = icon.parentNode;
                const allChildren = Array.from(parent.childNodes);
                const index = allChildren.indexOf(icon);

                // Вставить новый токен после SVG и еще SVG после него
                if (index > -1 && index < allChildren.length - 1) {
                    parent.insertBefore(newToken, allChildren[index + 1]);
                    parent.insertBefore(iconSvg, allChildren[index + 1]);
                } else {
                    parent.appendChild(newToken);
                    parent.appendChild(newIcon);
                }

                let position = word.getAttribute('data-position')
                if (position === null) {
                    ChangePositions(token, null);
                    position = 0;
                }
                else {
                    position++;
                    ChangePositions(token, word);
                }
            }

            // добавление каждому пустому токену функции по клику
            document.querySelectorAll('.clickable-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    ClickOnEmpty(icon);
                });
            });

            // Удаление пустых токенов
            document.getElementById('button-delete-tokens').addEventListener('click', () => {
                chosen.forEach(word => {
                    word.classList.remove('chosen_token');
                    if (word.classList.contains('empty-token')) {
                        let token = word.parentElement;
                        var nextSibling = token.nextSibling;
                        while (nextSibling && nextSibling.nodeType != 1) {
                            nextSibling = nextSibling.nextSibling
                        }
                        if (nextSibling.classList.contains('empty-token')) {
                            nextSibling.remove();
                        }
                        let tokens_container = token.parentElement;
                        //console.log(tokens_container);

                        token.remove();
                        ChangePositions(tokens_container, null);
                    }
                });

                chosen.splice(0, chosen.length);

                var menu = document.getElementById('select-menu');
                menu.classList.add('hide');
            });

            document.querySelectorAll('.word').forEach(word => {
                word.addEventListener('click', () => {
                    ClickOnWord(word);
                });
            });
        });

        // Скрипт для меню
        document.addEventListener('DOMContentLoaded', function() {
            const rateBtn = document.querySelector('.rate-btn');
            const modal = document.getElementById('modal');
            const closeModal = document.querySelector('.close-modal');
            const menuBlocks = document.querySelectorAll('.menu-block');
            const backButton = document.querySelector('.button-grey');


            menuBlocks.forEach(block => {
            block.addEventListener('click', function(e) {
                e.stopPropagation();

                const contentId = this.getAttribute('data-target');
                const content = document.getElementById(contentId);
                if (!content) return;

                const isAlreadyOpen = content.style.display === 'block';

                // Скрываем все другие контенты
                document.querySelectorAll('.menu-content').forEach(c => {
                    if (c !== content) {
                        c.style.display = 'none';
                    }
                });

                if (isAlreadyOpen) {
                    content.style.display = 'none';
                }
                else {
                    // Позиционируем текущий контент
                    const rect = this.getBoundingClientRect();
                    content.style.display = 'block';
                    content.style.position = 'fixed';
                    content.style.left = `${rect.left}px`;
                    content.style.top = `${rect.bottom}px`;
                    content.style.zIndex = '1001'; // Выше чем у меню
                }

                });
            });

            // Обновление позиции при прокрутке
            window.addEventListener('scroll', function() {
                document.querySelectorAll('.menu-content').forEach(content => {
                    if (content.style.display === 'block') {
                        const targetId = content.id.replace('-content', '');
                        const menuItem = document.querySelector(`[data-target="${content.id}"]`);
                        if (menuItem) {
                            const rect = menuItem.getBoundingClientRect();
                            content.style.left = `${rect.left}px`;
                            content.style.top = `${rect.bottom}px`;
                        }
                    }
                });
            });

            document.querySelectorAll('.menu-content').forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });

            document.addEventListener('click', function(e) {
                // Проверяем, был ли клик вне всех .menu-content и .menu-block
                const isClickInsideContent = Array.from(document.querySelectorAll('.menu-content, .menu-block')).some(
                    element => element.contains(e.target)
                );

                if (!isClickInsideContent) {
                    document.querySelectorAll('.menu-content').forEach(c => {
                        c.style.display = 'none';
                    });
                }
            });

            // Закрытие при клике вне и по кнопке назад
            document.addEventListener('click', function() {
                document.querySelectorAll('.menu-content').forEach(c => {
                c.style.display = 'none';
                });
            });

             // Обработчики для модального окна
            if (backButton) {
                backButton.addEventListener('click', function(e) {
                    e.preventDefault(); // Предотвращает отправку формы
                    modal.style.display = 'none';
                });
            }

            rateBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                document.querySelectorAll('.menu-content').forEach(c => {
                        c.style.display = 'none';
                });
                modal.style.display = 'flex';
            });

            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                modal.style.display = 'none';
                }
            });

            // Закрытие при ресайзе окна (перепозиционирование)
            window.addEventListener('resize', function() {
                document.querySelectorAll('.menu-content').forEach(content => {
                content.style.display = 'none';
                });
            });

        });

        // Открытие модального окна при клике на кнопку "Добавить аннотацию"
        document.getElementById('button-add-annotation').addEventListener('click', function() {
        /*
            const tags = [
                { name: 'Tag1' },
                { name: 'Tag2' },
                { name: 'Tag3' }
            ];

            const tagsList = document.getElementById('tags-list');
            tagsList.innerHTML = '';

            // Создаем элементы для тегов
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.classList.add('tag');
                tagElement.textContent = tag.name;
                tagElement.addEventListener('click', function() {
                    selectTag(tag);
                });
                tagsList.appendChild(tagElement);
            });
            */

            // Показать модальное окно
            document.getElementById('annotation-modal').style.display = 'flex';
        });

        // Закрытие модального окна
        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('annotation-modal').style.display = 'none';
        });

        // Закрытие модального окна, если кликнут вне окна
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('annotation-modal')) {
                document.getElementById('annotation-modal').style.display = 'none';
            }
        });

        // Функция для выбора тега
        // function selectTag(tag) {
        //     document.getElementById('selected-tag').value = tag.name;

        //     document.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        //     event.target.classList.add('selected');
        // }

        // Удаление аннотации
        // document.getElementById('delete-annotation').addEventListener('click', function() {
        //     document.getElementById('selected-tag').value = '';
        //     document.getElementById('error-reason').value = '';
        //     document.getElementById('severity').value = '';
        //     document.getElementById('correction').value = '';
        //     document.getElementById('comment').value = '';
        // });

        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('id_iderrortag');
            //const tagsList = document.getElementById('tags-list');
            const selectedTagDisplay = document.getElementById('selected-tag-name');

            function updateSelectedTagDisplay() {
                const selectedOption = select.options[select.selectedIndex];
                selectedTagDisplay.textContent = selectedOption ? selectedOption.text : 'Не выбран';
            }

            /*function renderTags() {
                tagsList.innerHTML = '';

                Array.from(select.options).forEach(option => {
                    if (option.value) {
                        const tagElement = document.createElement('div');
                        tagElement.classList.add('tag');
                        tagElement.textContent = option.text;
                        tagElement.dataset.value = option.value;

                        if (option.selected) {
                            tagElement.classList.add('selected');
                            updateSelectedTagDisplay();
                        }

                        tagElement.addEventListener('click', function() {
                            // Устанавливаем значение в оригинальном select
                            select.value = option.value;

                            // Обновляем выделение
                            document.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                            this.classList.add('selected');

                            // Обновляем отображение выбранного тега
                            updateSelectedTagDisplay();
                        });

                        tagsList.appendChild(tagElement);
                    }
                });
            }

            // Инициализация при загрузке
            renderTags();*/

            // document.getElementById('tag-search').addEventListener('input', function(e) {
            //     const searchTerm = e.target.value.toLowerCase();
            //     document.querySelectorAll('.tag').forEach(tag => {
            //         console.log(tag.parentElement);
            //         const tagText = tag.textContent.toLowerCase();
            //         tag.style.display = tagText.includes(searchTerm) ? 'block' : 'none';
            //         //console.log(tag.previousSibling);
            //         const svg_icon = tag.previousSibling;
            //         if (svg_icon != null) {
            //             svg_icon.style.display = tagText.includes(searchTerm) ? 'block' : 'none';
            //         }
            //     });
            // });

            // Обновляем при изменении select (на случай, если он меняется программно)
            // select.addEventListener('change', function() {
            //     renderTags();
            // });
        });

        async function addErrorAnnotation() {
            const sentence_ids = [];
            const positions = [];
            const sentencesMap = {};

            chosen.forEach(word => {
                if (word.classList.contains('empty-token')) {
                    let token = word.parentElement;
                    sentence_id = token.getAttribute('sentence_id');

                    if (!sentencesMap[sentence_id]) {
                        sentencesMap[sentence_id] = {
                            id_sentence: sentence_id,
                            empty_token_pos: [token.getAttribute('data-position')]
                        };
                    }
                    else {
                        let sentence = sentencesMap[sentence_id];
                        let token_pos = sentence[empty_token_pos];
                        token_pos.push(token.getAttribute('data-position'));
                    }
                }
            });

            const sentences = Object.values(sentencesMap);


            const data = {
                token_ids: chosen_ids,
                sentences: sentences,
                tag: document.getElementById('selected-tag-name').innerHTML,
                reason: document.getElementById('id_idreason').value,
                degree: document.getElementById('id_iderrorlevel').value,
                fix: document.getElementById('id_correct').value,
                comment: document.getElementById('id_comment').value
            };
            console.log(data);

            const response = fetch('/text/send_changes/', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // CSRF-токен для Django
                },
            });
        }

        function addAnnotation() {
            const data = {
                textgrade: document.getElementById('id_textgrade').value,
                completeness: document.getElementById('id_completeness').value,
                structure: document.getElementById('id_structure').value,
                coherence: document.getElementById('id_coherence').value,
                poscheckflag: document.getElementById('id_poscheckflag').value,
                errorcheckflag: document.getElementById('id_errorcheckflag').value
            };
            console.log(data);
        }
        </script>

</body>
</html>
